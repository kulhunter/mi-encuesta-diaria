<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Seguimiento de Encuesta Diario</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  canvas { max-width: 600px; margin-bottom: 50px; }
  #wordcloud { width: 600px; height: 400px; border: 1px solid #ccc; }
</style>
</head>
<body>
<h1>Seguimiento Diario - Últimos 30 días</h1>

<canvas id="motivationChart"></canvas>
<canvas id="gymChart"></canvas>
<canvas id="wakeChart"></canvas>
<canvas id="weedChart"></canvas>

<h2>Nube de palabras: Comentarios al yo del futuro</h2>
<div id="wordcloud"></div>

<script>
const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRjg0UxgWLiKFgDlJ-2ClMcOsIrWxWEbdSuwt-auAUmjIZ74rSGlB5HY-bomZkXuGNNg1jonvqTQP8d/pub?gid=0&single=true&output=csv';

// Cargar CSV
fetch(sheetCSV)
  .then(response => response.text())
  .then(csvText => {
    const data = d3.csvParse(csvText);
    processData(data);
  })
  .catch(console.error);

function processData(data) {
  // Filtrar últimos 30 días
  const today = new Date();
  const filtered = data.filter(d => {
    const dt = new Date(d.Fecha);
    return dt <= today && dt >= new Date(today.getTime() - 30*24*60*60*1000);
  });

  // Extraer arrays para gráficos
  const labels = filtered.map(d => d.Fecha);

  // Motivación (escala 1-5)
  const motivation = filtered.map(d => +d.motivación || 0);

  // Gimnasio respuestas
  const gymCounts = { Sí:0, 'No, pero me moví en casa':0, 'No lo logré':0 };
  filtered.forEach(d => {
    const g = d.gimnasio;
    if(gymCounts[g] !== undefined) gymCounts[g]++;
  });

  // Despertar
  const wakeCounts = { Energético:0, Normal:0, 'Cansado/a':0, 'Náuseas / malestar':0 };
  filtered.forEach(d => {
    const w = d.despertar;
    if(wakeCounts[w] !== undefined) wakeCounts[w]++;
  });

  // Consumo marihuana
  const weedCounts = { No:0, 'Solo en la noche':0, 'Durante el día':0, 'Todo el día':0 };
  filtered.forEach(d => {
    const c = d.consumo;
    if(weedCounts[c] !== undefined) weedCounts[c]++;
  });

  // Comentarios para nube de palabras
  const comments = filtered.map(d => d.comentario).filter(c => c && c.trim().length>0).join(' ').toLowerCase();

  // Dibujar gráficos
  drawMotivationChart(labels, motivation);
  drawGymChart(gymCounts);
  drawWakeChart(wakeCounts);
  drawWeedChart(weedCounts);
  drawWordCloud(comments);
}

function drawMotivationChart(labels, data) {
  const ctx = document.getElementById('motivationChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Motivación (1-5)',
        data,
        borderColor: 'blue',
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      scales: {
        y: { min: 0, max: 5, ticks: { stepSize: 1 } }
      }
    }
  });
}

function drawGymChart(counts) {
  const ctx = document.getElementById('gymChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: 'Respuestas gimnasio',
        data: Object.values(counts),
        backgroundColor: ['green','orange','red']
      }]
    }
  });
}

function drawWakeChart(counts) {
  const ctx = document.getElementById('wakeChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: 'Cómo te sentiste al despertar',
        data: Object.values(counts),
        backgroundColor: ['#4CAF50','#FFC107','#F44336','#9C27B0']
      }]
    }
  });
}

function drawWeedChart(counts) {
  const ctx = document.getElementById('weedChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: 'Consumo de marihuana',
        data: Object.values(counts),
        backgroundColor: ['#607D8B','#3F51B5','#2196F3','#03A9F4']
      }]
    }
  });
}

// Nube de palabras con d3-cloud
function drawWordCloud(text) {
  const wordCounts = {};
  const words = text.match(/\b\w+\b/g);
  if(!words) return;

  words.forEach(w => {
    wordCounts[w] = (wordCounts[w] || 0) + 1;
  });

  const wordEntries = Object.entries(wordCounts).map(([text, size]) => ({text, size}));

  const layout = d3.layout.cloud()
    .size([600, 400])
    .words(wordEntries)
    .padding(5)
    .rotate(() => 0)
    .fontSize(d => Math.min(60, 10 + d.size * 5))
    .on("end", draw);

  layout.start();

  function draw(words) {
    d3.select("#wordcloud").html("");
    const svg = d3.select("#wordcloud").append("svg")
      .attr("width", layout.size()[0])
      .attr("height", layout.size()[1]);

    const g = svg.append("g")
      .attr("transform", "translate(" + layout.size()[0]/2 + "," + layout.size()[1]/2 + ")");

    g.selectAll("text")
      .data(words)
      .enter().append("text")
      .style("font-size", d => d.size + "px")
      .style("fill", () => "hsl(" + Math.random()*360 + ", 70%, 50%)")
      .attr("text-anchor", "middle")
      .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
      .text(d => d.text);
  }
}
</script>
</body>
</html>
