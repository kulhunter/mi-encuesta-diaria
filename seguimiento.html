<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Seguimiento de Encuesta</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #chart-container { width: 90%; max-width: 800px; margin: auto; }
  #word-cloud { width: 90%; height: 400px; margin: 40px auto; border: 1px solid #ddd; }
  h2 { text-align: center; }
</style>
</head>
<body>

<h2>Seguimiento Últimos 30 días</h2>

<div id="chart-container">
  <canvas id="lineChart"></canvas>
</div>

<h2>Nube de palabras - Comentarios</h2>
<div id="word-cloud"></div>

<script>
const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRjg0UxgWLiKFgDlJ-2ClMcOsIrWxWEbdSuwt-auAUmjIZ74rSGlB5HY-bomZkXuGNNg1jonvqTQP8d/pub?output=csv';

// Función para parsear CSV en objetos JS
async function fetchCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    let obj = {};
    headers.forEach((h,i) => obj[h.trim()] = cols[i] ? cols[i].trim().replace(/^"|"$/g, '') : '');
    return obj;
  });
}

// Filtra últimos 30 días con base en Timestamp
function filterLast30Days(data) {
  const hoy = new Date();
  const ms30 = 30 * 24 * 60 * 60 * 1000;
  return data.filter(d => {
    const fechaStr = d.Timestamp;
    if (!fechaStr) return false;
    const fecha = new Date(fechaStr);
    return fecha && (hoy - fecha) <= ms30 && (hoy - fecha) >= 0;
  }).sort((a,b) => new Date(a.Timestamp) - new Date(b.Timestamp));
}

// Prepara datos para Chart.js
function prepareChartData(data) {
  const labels = data.map(d => {
    const f = new Date(d.Timestamp);
    return f.toLocaleDateString();
  });
  const motivacion = data.map(d => Number(d['¿Qué tan motivado/a estuviste hoy?'] || 0));
  return {labels, motivacion};
}

// Dibuja gráfico lineal de motivación
function drawChart(labels, data) {
  const ctx = document.getElementById('lineChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Motivación (1-5)',
        data,
        borderColor: 'blue',
        fill: false,
        tension: 0.2,
        pointRadius: 4,
        pointHoverRadius: 6,
      }]
    },
    options: {
      scales: {
        y: {
          min: 0,
          max: 5,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

// Nube de palabras con comentarios (limpiando palabras comunes)
function drawWordCloud(texts) {
  const allText = texts.join(' ').toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()"]/g,"");
  const stopWords = ['para','del','y','que','la','el','de','mi','tu','yo','me','se','con','sin','por','las','los','un','una','es','en','al','lo','como','a','si','te','le','los','las','su'];
  const words = allText.split(/\s+/).filter(w => w.length > 2 && !stopWords.includes(w));
  const freqMap = {};
  words.forEach(w => freqMap[w] = (freqMap[w] || 0) + 1);
  const wordEntries = Object.entries(freqMap).map(([text, size]) => ({text, size: size * 10}));

  const width = document.getElementById('word-cloud').clientWidth;
  const height = document.getElementById('word-cloud').clientHeight;

  const layout = d3.layout.cloud()
    .size([width, height])
    .words(wordEntries)
    .padding(5)
    .rotate(() => 0)
    .fontSize(d => d.size)
    .on("end", draw);

  layout.start();

  function draw(words) {
    d3.select("#word-cloud").append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", `translate(${width/2},${height/2})`)
      .selectAll("text")
      .data(words)
      .enter().append("text")
      .style("font-size", d => d.size + "px")
      .style("fill", () => `hsl(${Math.random()*360},70%,50%)`)
      .attr("text-anchor", "middle")
      .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
      .text(d => d.text);
  }
}

async function main() {
  const rawData = await fetchCSV(sheetCSV);
  const data30 = filterLast30Days(rawData);
  const chartData = prepareChartData(data30);
  drawChart(chartData.labels, chartData.motivacion);

  const comentarios = data30.map(d => d['¿Quieres dejar un comentario para tu yo del futuro?'] || '');
  drawWordCloud(comentarios);
}

main();
</script>

</body>
</html>
